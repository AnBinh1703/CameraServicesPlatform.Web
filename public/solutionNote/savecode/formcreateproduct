import { AppstoreOutlined } from "@ant-design/icons";
import {
  Button,
  Card,
  Descriptions,
  Form,
  Modal,
  Table,
  Typography,
  message,
} from "antd";
import React, { useEffect, useState } from "react";
import { useSelector } from "react-redux";
import { getSupplierIdByAccountId } from "../../../api/accountApi";
import {
  createComboOfSupplier,
  getAllCombos,
  getComboById,
} from "../../../api/comboApi";
import ComboRegistrationModal from "../Combo/ComboRegistrationModal";

const formatter = new Intl.NumberFormat("vi-VN", {
  style: "currency",
  currency: "VND",
});

const formatDateTime = (dateTime) => {
  const date = new Date(dateTime);
  const day = String(date.getDate()).padStart(2, "0");
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, "0");
  const minutes = String(date.getMinutes()).padStart(2, "0");
  return `${day}/${month}/${year} ${hours}:${minutes}`;
};

const calculateRemainingTime = (endTime) => {
  const now = new Date();
  const end = new Date(endTime);
  const remainingTime = end - now;
  return remainingTime > 0 ? remainingTime : 0;
};

const durationMap = {
  0: 1,
  1: 2,
  2: 3,
  3: 5,
};

const getDurationText = (duration) => {
  const months = Number(duration) || 0;
  return `${months} Tháng`;
};

const ComboCarousel = ({ combos, totalCombos, totalDuration }) => {
  
  const [supplierId, setSupplierId] = useState(null);
  const { user } = useSelector((state) => state.user || {});
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [comboDetails, setComboDetails] = useState(null);
  const [selectedComboId, setSelectedComboId] = useState(null);
  const [form] = Form.useForm();
  const [currentStep, setCurrentStep] = useState(0);
  const [isComboModalVisible, setIsComboModalVisible] = useState(false);
  const [confirmLoading, setConfirmLoading] = useState(false);
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  };

  useEffect(() => {
    const fetchSupplierId = async () => {
      if (user.id) {
        try {
          const response = await getSupplierIdByAccountId(user.id);
          console.log("Supplier ID response:", response);
          if (response?.isSuccess && response.result) {
            setSupplierId(response.result);
            console.log("Successfully set supplier ID:", response.result);
          } else {
            console.error("Invalid supplier ID response:", response);
            message.error("Lấy mã nhà cung cấp không thành công.");
          }
        } catch (error) {
          console.error("Error fetching supplier ID:", error);
          message.error("Lỗi khi lấy mã nhà cung cấp.");
        }
      } else {
        console.error("No user ID available");
        message.error("Không tìm thấy ID người dùng.");
      }
    };

    fetchSupplierId();
  }, [user.id]);

    const viewDetails = async (id) => {
      try {
        const combo = await getComboById(id);
        setComboDetails(combo.result);
        console.log("Combo details:", combo.result); // Log combo details to verify
        setIsModalVisible(true);
      } catch (error) {
        console.error("Failed to fetch combo details:", error);
        setComboDetails(null);
      }
    };

  const handleCancel = () => {
    setIsModalVisible(false);
  };

  const handleOk = () => {
    setIsModalVisible(false);
    setComboDetails(null);
  };

  // Sort combos by startTime (latest first)
  const sortedCombos = [...combos].sort(
    (a, b) => new Date(b.startTime) - new Date(a.startTime)
  );

  const columns = [
    {
      title: "Tên Combo",
      dataIndex: "comboName",
      key: "comboName",
    },
    {
      title: "Giá Combo",
      dataIndex: "comboPrice",
      key: "comboPrice",
      render: (text) => formatter.format(text),
    },
    {
      title: "Bắt đầu",
      dataIndex: "startTime",
      key: "startTime",
    },
    {
      title: "Kết Thúc",
      dataIndex: "endTime",
      key: "endTime",
      render: (text) => {
        const remainingTime = calculateRemainingTime(text);
        const isExpired = remainingTime <= 0;
        return (
          <span
            style={{
              color: isExpired ? "#ff4d4f" : "#52c41a",
              fontWeight: "bold",
            }}
          >
            {isExpired
              ? `${formatDateTime(text)} (Đã hết hạn)`
              : `${formatDateTime(text)} (Còn lại: ${Math.ceil(
                  remainingTime / (1000 * 60 * 60 * 24)
                )} ngày)`}
          </span>
        );
      },
    },
    {
      title: "Hành động",
      key: "action",
      render: (text, record) => (
        <Button onClick={() => viewDetails(record.comboId)}>
          Xem chi tiết
        </Button>
      ),
    },
  ];
  const next = () => {
    setCurrentStep(currentStep + 1);
  };

  const prev = () => {
    setCurrentStep(currentStep - 1);
  };

  const showComboModal = () => {
    setIsComboModalVisible(true);
  };

  const handleComboModalCancel = () => {
    setIsComboModalVisible(false);
  };

  const handleChoosePlan = (comboId) => {
    handleCardClick(comboId);
    next();
  };
  const handleCardClick = (comboId) => {
    setSelectedComboId(comboId);
    form.setFieldsValue({ comboId });
  };
  const handleCreateCombo = async () => {
    if (!supplierId) {
      console.error("No supplier ID available");
      message.error("Không tìm thấy mã nhà cung cấp.");
      return;
    }
    console.log("Creating combo with supplier ID:", supplierId);

    setConfirmLoading(true);

    const comboData = {
      supplierID: supplierId,
      comboId: selectedComboId,
    };

    try {
      const response = await createComboOfSupplier(comboData);
      if (response?.isSuccess) {
        message.success("Tạo combo thành công.");
        form.resetFields();
        if (response.result) {
          window.location.href = response.result;
        }
      } else {
        message.error("Tạo combo thất bại.");
      }
    } catch (error) {
      message.error("Lỗi khi tạo combo.");
    } finally {
      setConfirmLoading(false);
      setIsComboModalVisible(false);
    }
  };
  useEffect(() => {
    const fetchCombos = async () => {
      try {
        const response = await getAllCombos();
        if (response?.isSuccess) {
          setCombos(response.result);
        } else {
          message.error("Không thể lấy danh sách combo.");
        }
      } catch (error) {
        message.error("Lỗi khi lấy danh sách combo.");
      }
    };

    fetchCombos();
  }, []);
  const steps = [
    {
      title: "Chọn Gói",
      content: "Chọn gói dịch vụ",
    },
    {
      title: "Chọn thời gian",
      content: "Chọn thời gian bắt đầu",
    },
    {
      title: "Xác nhận",
      content: "Xác nhận thông tin",
    },
  ];
  return (
    <Card
      title={
        <div className="flex items-center justify-between">
          <span>
            <AppstoreOutlined /> Gói Combo Đăng Kí
          </span>
          <Button type="primary" onClick={showComboModal}>
            Đăng ký Combo mới
          </Button>
        </div>
      }
    >
      <ComboRegistrationModal
        isComboModalVisible={isComboModalVisible}
        handleComboModalCancel={handleComboModalCancel}
        currentStep={currentStep}
        steps={steps}
        combos={combos}
        selectedComboId={selectedComboId}
        handleCardClick={handleCardClick}
        handleChoosePlan={handleChoosePlan}
        form={form}
        next={next}
        prev={prev}
        handleCreateCombo={handleCreateCombo}
        confirmLoading={confirmLoading}
        formatCurrency={formatCurrency}
      />
      {sortedCombos.length > 0 ? (
        <>
          <Table
            dataSource={sortedCombos}
            columns={columns}
            rowKey="comboOfSupplierId"
            pagination={false}
            rowClassName={(record) =>
              calculateRemainingTime(record.endTime) <= 0 ? "text-gray-400" : ""
            }
          />
          <Modal
            title="Chi tiết Combo"
            visible={isModalVisible}
            onOk={handleOk}
            onCancel={handleCancel}
          >
            {comboDetails && (
              <Descriptions bordered column={1} size="small">
                <Descriptions.Item label="Tên Combo">
                  {comboDetails.comboName}
                </Descriptions.Item>
                <Descriptions.Item label="Giá Combo">
                  {formatter.format(comboDetails.comboPrice)}
                </Descriptions.Item>
                <Descriptions.Item label="Thời lượng Combo">
                  {getDurationText(comboDetails.durationCombo)}
                </Descriptions.Item>
                <Descriptions.Item label="Trạng thái">
                  {comboDetails.isDisable ? "Vô hiệu hóa" : "Đang hoạt động"}
                </Descriptions.Item>
                <Descriptions.Item label="Ngày tạo">
                  {formatDateTime(comboDetails.createdAt)}
                </Descriptions.Item>
                <Descriptions.Item label="Ngày cập nhật">
                  {formatDateTime(comboDetails.updatedAt)}
                </Descriptions.Item>
              </Descriptions>
            )}
          </Modal>
        </>
      ) : (
        <Typography.Text>Không có Combo nào.</Typography.Text>
      )}
    </Card>
  );
};

export default ComboCarousel;
